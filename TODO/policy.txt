currently the HOLD/FILTER switch is determined by the type of exception we raise.
Replace this with a generic return type and have the type of return be in the configuration file.

The 'normal' postfix policy daemon is totally broken since the change of the internal API
writting of intelligent anti-spam rules based on http://spamhints.org/

There is a bug when you request more connection that the connection pool has.
It seems that the threading can cause somehow a deadlock (or was causing)
It can not be hit currently as the plugin are running with a global lock.
To investigate in order to improve performance.

We should fail gracefully if we do not have the right to read/write to the plugin DB folder

2008/09/22 15:43 +0100 [-] initialisation of plugin greylist
2008/09/22 15:43 +0100 [-]   * initialisation of the database
2008/09/22 15:43 +0100 [-] Traceback (most recent call last):
2008/09/22 15:43 +0100 [-]   File "ppolicyd.tac", line 79, in <module>
2008/09/22 15:43 +0100 [-]     mailservice = MailPolicyService(configuration)
2008/09/22 15:43 +0100 [-]   File "/usr/lib/python2.5/site-packages/ppolicyd/service.py", line 62, in __init__
2008/09/22 15:43 +0100 [-]     if plugin.initialise(self):
2008/09/22 15:43 +0100 [-]   File "/usr/lib/python2.5/site-packages/ppolicyd/plugin.py", line 64, in initialise
2008/09/22 15:43 +0100 [-]     self.initialised = self._databaseConnection()
2008/09/22 15:43 +0100 [-]   File "/usr/lib/python2.5/site-packages/ppolicyd/plugin.py", line 84, in _databaseConnection
2008/09/22 15:43 +0100 [-]     self.database = ConnectionPool(name,sqlite_file)
2008/09/22 15:43 +0100 [-]   File "/usr/lib/python2.5/site-packages/exa/database/pool.py", line 54, in __init__
2008/09/22 15:43 +0100 [-]     self.connections.append(PoolConnection(self,self.api,*self.args,**self.kw))
2008/09/22 15:43 +0100 [-]   File "/usr/lib/python2.5/site-packages/exa/database/pool.py", line 15, in __init__
2008/09/22 15:43 +0100 [-]     Connection.__init__(self,*args,**kw)
2008/09/22 15:43 +0100 [-]   File "/usr/lib/python2.5/site-packages/exa/database/connection.py", line 32, in __init__
2008/09/22 15:43 +0100 [-]     self._connect()
2008/09/22 15:43 +0100 [-]   File "/usr/lib/python2.5/site-packages/exa/database/connection.py", line 64, in _connect
2008/09/22 15:43 +0100 [-]     self._connection = self.api2.connect(*self.args, **self.kw)
2008/09/22 15:43 +0100 [-] sqlite3.OperationalError: unable to open database file

Threads and DB are really not working well together with SQLITE

[root@sp-fw-1 scavenger]# ./service/scavenger-policy/run2009/01/23 10:35 +0100 [-] Log opened.
2009/01/23 10:35 +0100 [-] Psyco is not available
2009/01/23 10:35 +0100 [-] ********************************************************************************
2009/01/23 10:35 +0100 [-] configuration is /opt/scavenger/etc/scavenger/policy/scavenger.conf
2009/01/23 10:35 +0100 [-]   * database_prefix = scavenger
2009/01/23 10:35 +0100 [-]   * database_path   = /opt/scavenger/db/
2009/01/23 10:35 +0100 [-]   * database_port   = 3306
2009/01/23 10:35 +0100 [-]   * thread          = 200
2009/01/23 10:35 +0100 [-]   * ip              = 127.0.0.1
2009/01/23 10:35 +0100 [-]   * acl             = ['127.0.0.1', '192.168.0.0/24']
2009/01/23 10:35 +0100 [-]   * database_password = password
2009/01/23 10:35 +0100 [-]   * api             = sqlite3
2009/01/23 10:35 +0100 [-]   * database_host   = 127.0.0.1
2009/01/23 10:35 +0100 [-]   * database_user   = user
2009/01/23 10:35 +0100 [-]   * timeout         = 60
2009/01/23 10:35 +0100 [-]   * plugins         = ['ratio', 'helo']
2009/01/23 10:35 +0100 [-]   * debug           = 0
2009/01/23 10:35 +0100 [-]   * message         = 
2009/01/23 10:35 +0100 [-]   * type            = scavenger
2009/01/23 10:35 +0100 [-]   * port            = 25253
2009/01/23 10:35 +0100 [-]   * pidfile         = /var/run/scavenger-scavenger.pid
2009/01/23 10:35 +0100 [-] ********************************************************************************
2009/01/23 10:35 +0100 [-] initialisation of plugin helo
2009/01/23 10:35 +0100 [-]   * reading configuration file
2009/01/23 10:35 +0100 [-]   * running plugin initialisation
2009/01/23 10:35 +0100 [-]   * complete
2009/01/23 10:35 +0100 [-] initialisation of plugin ratio
2009/01/23 10:35 +0100 [-]   * reading configuration file
2009/01/23 10:35 +0100 [-]   * running plugin initialisation
2009/01/23 10:35 +0100 [-]   * complete
2009/01/23 10:35 +0100 [-] --------------------------------------------------------------------------------
2009/01/23 10:35 +0100 [-] skipping uncalled plugin deny
2009/01/23 10:35 +0100 [-] skipping uncalled plugin spread
2009/01/23 10:35 +0100 [-] skipping uncalled plugin allow
2009/01/23 10:35 +0100 [-] ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
2009/01/23 10:35 +0100 [-] twisted.protocols.policies.TimeoutFactory starting on 25253
2009/01/23 10:35 +0100 [-] Starting factory <scavenger.policy.factory.MailPolicyFactoryFromService instance at 0xb764fd8c>
2009/01/23 10:35 +0100 [-] Starting factory <twisted.protocols.policies.TimeoutFactory instance at 0xb76e8f2c>
2009/01/23 10:35 +0100 [TimeoutProtocol,0,127.0.0.1] 
2009/01/23 10:35 +0100 [TimeoutProtocol,1,127.0.0.1] 
2009/01/23 10:35 +0100 [-] HAM
2009/01/23 10:35 +0100 [-] HAM
2009/01/23 10:35 +0100 [TimeoutProtocol,2,127.0.0.1] 
2009/01/23 10:35 +0100 [-] HAM
2009/01/23 10:35 +0100 [TimeoutProtocol,3,127.0.0.1] 
2009/01/23 10:35 +0100 [-] HAM
2009/01/23 10:36 +0100 [TimeoutProtocol,4,127.0.0.1] 
2009/01/23 10:36 +0100 [TimeoutProtocol,5,127.0.0.1] 
2009/01/23 10:36 +0100 [TimeoutProtocol,6,127.0.0.1] 
2009/01/23 10:36 +0100 [-] HAM
2009/01/23 10:36 +0100 [TimeoutProtocol,7,127.0.0.1] 
2009/01/23 10:36 +0100 [TimeoutProtocol,7,127.0.0.1] creating new db connection
2009/01/23 10:36 +0100 [TimeoutProtocol,5,127.0.0.1] creating new db connection
2009/01/23 10:36 +0100 [TimeoutProtocol,8,127.0.0.1] 
2009/01/23 10:36 +0100 [TimeoutProtocol,7,127.0.0.1] dropping extra connection
2009/01/23 10:36 +0100 [TimeoutProtocol,7,127.0.0.1] Exception exceptions.AttributeError: "class Connection has no attribute '__del__'" in <bound method PoolConnection.__del__ of <scavenger.tools.database.pool.PoolConnection instance at 0xb765c94c>> ignored
2009/01/23 10:36 +0100 [TimeoutProtocol,6,127.0.0.1] dropping extra connection
2009/01/23 10:36 +0100 [TimeoutProtocol,6,127.0.0.1] Exception exceptions.AttributeError: "class Connection has no attribute '__del__'" in <bound method PoolConnection.__del__ of <scavenger.tools.database.pool.PoolConnection instance at 0xb764faec>> ignored
2009/01/23 10:36 +0100 [-] HAM
2009/01/23 10:36 +0100 [TimeoutProtocol,9,127.0.0.1] 
2009/01/23 10:36 +0100 [-] HAM
2009/01/23 10:36 +0100 [TimeoutProtocol,10,127.0.0.1] 
2009/01/23 10:36 +0100 [-] HAM
2009/01/23 10:36 +0100 [TimeoutProtocol,11,127.0.0.1] 
2009/01/23 10:36 +0100 [-] HAM
2009/01/23 10:36 +0100 [TimeoutProtocol,12,127.0.0.1] 
2009/01/23 10:36 +0100 [-] HAM
2009/01/23 10:36 +0100 [TimeoutProtocol,13,127.0.0.1] 
2009/01/23 10:36 +0100 [-] HAM
2009/01/23 10:36 +0100 [TimeoutProtocol,14,127.0.0.1] 
2009/01/23 10:36 +0100 [-] HAM
2009/01/23 10:36 +0100 [TimeoutProtocol,15,127.0.0.1] 
2009/01/23 10:36 +0100 [TimeoutProtocol,16,127.0.0.1] 
2009/01/23 10:36 +0100 [TimeoutProtocol,17,127.0.0.1] 
2009/01/23 10:36 +0100 [TimeoutProtocol,17,127.0.0.1] creating new db connection
2009/01/23 10:36 +0100 [TimeoutProtocol,17,127.0.0.1] Unhandled error in Deferred:
2009/01/23 10:36 +0100 [TimeoutProtocol,17,127.0.0.1] Unhandled Error
	Traceback (most recent call last):
	  File "/usr/lib/python2.5/site-packages/twisted/python/context.py", line 59, in callWithContext
	    return self.currentContext().callWithContext(ctx, func, *args, **kw)
	  File "/usr/lib/python2.5/site-packages/twisted/python/context.py", line 37, in callWithContext
	    return func(*args,**kw)
	  File "/usr/lib/python2.5/site-packages/twisted/internet/defer.py", line 239, in callback
	    self._startRunCallbacks(result)
	  File "/usr/lib/python2.5/site-packages/twisted/internet/defer.py", line 304, in _startRunCallbacks
	    self._runCallbacks()
	--- <exception caught here> ---
	  File "/usr/lib/python2.5/site-packages/twisted/internet/defer.py", line 317, in _runCallbacks
	    self.result = callback(self.result, *args, **kw)
	  File "/opt/scavenger/lib/scavenger/policy/factory.py", line 94, in policeMessage
	    plugin.update(message)
	  File "/opt/scavenger/lib/scavenger/policy/plugins/scavenger/ratio.py", line 155, in update
	    self.database.increment(client,server,state,code)
	  File "/opt/scavenger/lib/scavenger/policy/plugins/scavenger/ratio.py", line 78, in increment
	    return self.insert(query,client,server)
	  File "/opt/scavenger/lib/scavenger/policy/plugin/plugin.py", line 112, in <lambda>
	    return lambda *args, **kwargs: self.__runattr(cursor, method, *args, **kwargs)
	  File "/opt/scavenger/lib/scavenger/policy/plugin/plugin.py", line 107, in __runattr
	    return method(*args,**kwargs)
	  File "/opt/scavenger/lib/scavenger/tools/database/connection.py", line 202, in insert
	    self._cursor.execute(query, args)
	sqlite3.OperationalError: database is locked
	
2009/01/23 10:36 +0100 [TimeoutProtocol,18,127.0.0.1] 
2009/01/23 10:36 +0100 [-] HAM
2009/01/23 10:36 +0100 [TimeoutProtocol,16,127.0.0.1] dropping extra connection
2009/01/23 10:36 +0100 [TimeoutProtocol,16,127.0.0.1] Exception exceptions.AttributeError: "class Connection has no attribute '__del__'" in <bound method PoolConnection.__del__ of <scavenger.tools.database.pool.PoolConnection instance at 0xb764fa2c>> ignored
2009/01/23 10:36 +0100 [-] HAM
2009/01/23 10:36 +0100 [-] Received SIGINT, shutting down.
2009/01/23 10:36 +0100 [twisted.protocols.policies.TimeoutFactory] (Port 25253 Closed)
2009/01/23 10:36 +0100 [twisted.protocols.policies.TimeoutFactory] Stopping factory <scavenger.policy.factory.MailPolicyFactoryFromService instance at 0xb764fd8c>
2009/01/23 10:36 +0100 [twisted.protocols.policies.TimeoutFactory] Stopping factory <twisted.protocols.policies.TimeoutFactory instance at 0xb76e8f2c>
2009/01/23 10:36 +0100 [-] Unhandled error in Deferred:
2009/01/23 10:36 +0100 [-] Unhandled Error
	Traceback (most recent call last):
	  File "/usr/lib/python2.5/site-packages/twisted/python/context.py", line 59, in callWithContext
	    return self.currentContext().callWithContext(ctx, func, *args, **kw)
	  File "/usr/lib/python2.5/site-packages/twisted/python/context.py", line 37, in callWithContext
	    return func(*args,**kw)
	  File "/usr/lib/python2.5/site-packages/twisted/internet/defer.py", line 239, in callback
	    self._startRunCallbacks(result)
	  File "/usr/lib/python2.5/site-packages/twisted/internet/defer.py", line 304, in _startRunCallbacks
	    self._runCallbacks()
	--- <exception caught here> ---
	  File "/usr/lib/python2.5/site-packages/twisted/internet/defer.py", line 317, in _runCallbacks
	    self.result = callback(self.result, *args, **kw)
	  File "/opt/scavenger/lib/scavenger/policy/factory.py", line 94, in policeMessage
	    plugin.update(message)
	  File "/opt/scavenger/lib/scavenger/policy/plugins/scavenger/ratio.py", line 149, in update
	    if not self.database.increment(client,server,state,code):
	  File "/opt/scavenger/lib/scavenger/policy/plugins/scavenger/ratio.py", line 78, in increment
	    return self.insert(query,client,server)
	  File "/opt/scavenger/lib/scavenger/policy/plugin/plugin.py", line 112, in <lambda>
	    return lambda *args, **kwargs: self.__runattr(cursor, method, *args, **kwargs)
	  File "/opt/scavenger/lib/scavenger/policy/plugin/plugin.py", line 107, in __runattr
	    return method(*args,**kwargs)
	  File "/opt/scavenger/lib/scavenger/tools/database/connection.py", line 202, in insert
	    self._cursor.execute(query, args)
	sqlite3.OperationalError: database is locked
	

